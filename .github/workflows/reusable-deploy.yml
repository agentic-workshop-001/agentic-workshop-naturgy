# ============================================================
# Reusable Deploy Workflow
#
# Deploys the Naturgy Gas Workshop application to AWS:
#   1. deploy-infra    – Terraform plan + apply → outputs ECR/ECS/S3/ALB values
#   2. deploy-frontend – Sync React/Vite dist to S3 (parallel with backend)
#   3. deploy-backend  – Build & push Docker image, update ECS Fargate service
#   4. verify-deploy   – ALB + S3 health checks, upload deploy evidence
#
# All infrastructure values (ECR URL, S3 bucket, ECS cluster/service, ALB URL)
# are derived from Terraform outputs — no extra secrets needed beyond AWS creds.
#
# Required secrets (via secrets: inherit from caller):
#   AWS_ACCESS_KEY_ID     – IAM access key
#   AWS_SECRET_ACCESS_KEY – IAM secret key
#   AWS_REGION            – AWS region (eu-west-1)
# ============================================================

name: Reusable – Deploy to AWS

on:
  workflow_call:
    inputs:
      environment:
        description: "Target deployment environment (e.g. staging, production)"
        required: true
        type: string
    outputs:
      backend_url:
        description: "ALB URL for the backend API"
        value: ${{ jobs.deploy-infra.outputs.backend_url }}
      frontend_url:
        description: "S3 website URL for the frontend"
        value: ${{ jobs.deploy-infra.outputs.frontend_url }}

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ──────────────────────────────────────────────────────────
  # Job 1: Provision / update infrastructure via Terraform
  # ──────────────────────────────────────────────────────────
  deploy-infra:
    name: Terraform – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.tf-out.outputs.backend_url }}
      frontend_url: ${{ steps.tf-out.outputs.frontend_url }}
      ecr_url: ${{ steps.tf-out.outputs.ecr_url }}
      s3_bucket: ${{ steps.tf-out.outputs.s3_bucket }}
      ecs_cluster: ${{ steps.tf-out.outputs.ecs_cluster }}
      ecs_service: ${{ steps.tf-out.outputs.ecs_service }}

    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Configure AWS credentials
        uses: ./.github/actions/aws-auth
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd # v3.1.2
        with:
          terraform_wrapper: false

      - name: Terraform init
        run: terraform -chdir=terraform init

      - name: Terraform plan
        run: |
          terraform -chdir=terraform plan \
            -var="environment=${{ inputs.environment }}" \
            -var="aws_region=${{ secrets.AWS_REGION }}" \
            -out=tfplan

      - name: Terraform apply
        run: terraform -chdir=terraform apply -auto-approve tfplan

      - name: Export Terraform outputs
        id: tf-out
        run: |
          cd terraform
          echo "backend_url=$(terraform output -raw backend_url)" >> "$GITHUB_OUTPUT"
          echo "frontend_url=$(terraform output -raw frontend_url)" >> "$GITHUB_OUTPUT"
          echo "ecr_url=$(terraform output -raw ecr_repository_url)" >> "$GITHUB_OUTPUT"
          echo "s3_bucket=$(terraform output -raw s3_bucket_name)" >> "$GITHUB_OUTPUT"
          echo "ecs_cluster=$(terraform output -raw ecs_cluster_name)" >> "$GITHUB_OUTPUT"
          echo "ecs_service=$(terraform output -raw ecs_service_name)" >> "$GITHUB_OUTPUT"

  # ──────────────────────────────────────────────────────────
  # Job 2: Sync React/Vite build to S3 (parallel with backend)
  # ──────────────────────────────────────────────────────────
  deploy-frontend:
    name: Deploy Frontend – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: deploy-infra

    steps:
      - name: Download frontend-dist artifact
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          name: frontend-dist
          path: dist/

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@5579c002bb4778aa43395ef1df492868a9a1c83f # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Sync frontend dist to S3
        run: |
          echo "::add-mask::${{ needs.deploy-infra.outputs.s3_bucket }}"
          aws s3 sync dist/ "s3://${{ needs.deploy-infra.outputs.s3_bucket }}" --delete

  # ──────────────────────────────────────────────────────────
  # Job 3: Build Docker image, push to ECR, update ECS service
  # ──────────────────────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: deploy-infra

    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@5579c002bb4778aa43395ef1df492868a9a1c83f # v4.0.2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@4625ce35226a7557230889aae2f52eb50ec3dcda # v2.0.1

      - name: Build Docker image
        run: |
          IMAGE="${{ needs.deploy-infra.outputs.ecr_url }}:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker tag "$IMAGE" "${{ needs.deploy-infra.outputs.ecr_url }}:latest"

      - name: Push Docker image to ECR
        run: |
          docker push "${{ needs.deploy-infra.outputs.ecr_url }}:${{ github.sha }}"
          docker push "${{ needs.deploy-infra.outputs.ecr_url }}:latest"

      - name: Update ECS service with new image
        run: |
          aws ecs update-service \
            --cluster "${{ needs.deploy-infra.outputs.ecs_cluster }}" \
            --service "${{ needs.deploy-infra.outputs.ecs_service }}" \
            --force-new-deployment

      - name: Wait for ECS service stability
        run: |
          aws ecs wait services-stable \
            --cluster "${{ needs.deploy-infra.outputs.ecs_cluster }}" \
            --services "${{ needs.deploy-infra.outputs.ecs_service }}"

  # ──────────────────────────────────────────────────────────
  # Job 4: Health checks + deploy evidence
  # ──────────────────────────────────────────────────────────
  verify-deploy:
    name: Verify Deploy – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    needs: [deploy-infra, deploy-frontend, deploy-backend]

    steps:
      - name: Health check backend (retry up to 5 attempts)
        run: |
          ALB_URL="${{ needs.deploy-infra.outputs.backend_url }}"
          echo "::add-mask::$ALB_URL"
          echo "Checking backend at ${ALB_URL}/api/gas/supply-points"

          for attempt in 1 2 3 4 5; do
            if curl --fail --silent --max-time 10 "${ALB_URL}/api/gas/supply-points" > /dev/null; then
              echo "Backend is healthy (attempt $attempt)."
              exit 0
            fi
            echo "Attempt $attempt/5 failed – retrying in 30s…"
            sleep 30
          done
          echo "Backend health check failed after 5 attempts."
          exit 1

      - name: Verify frontend accessible (retry up to 3 attempts)
        run: |
          FRONTEND_URL="${{ needs.deploy-infra.outputs.frontend_url }}"
          echo "::add-mask::$FRONTEND_URL"
          echo "Checking frontend at $FRONTEND_URL"

          for attempt in 1 2 3; do
            if curl --fail --silent --max-time 10 "$FRONTEND_URL" > /dev/null; then
              echo "Frontend is accessible (attempt $attempt)."
              exit 0
            fi
            echo "Attempt $attempt/3 failed – retrying in 15s…"
            sleep 15
          done
          echo "Frontend health check failed after 3 attempts."
          exit 1

      - name: Generate deploy evidence
        if: always()
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > deploy-evidence.json <<EVIDENCE
          {
            "backend_url": "${{ needs.deploy-infra.outputs.backend_url }}",
            "frontend_url": "${{ needs.deploy-infra.outputs.frontend_url }}",
            "sha": "${{ github.sha }}",
            "timestamp": "$TIMESTAMP",
            "environment": "${{ inputs.environment }}",
            "status": "success"
          }
          EVIDENCE
          echo "Deploy evidence:"
          cat deploy-evidence.json

      - name: Upload deploy evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: deploy-evidence
          path: deploy-evidence.json
          retention-days: 30
