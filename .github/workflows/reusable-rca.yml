name: Reusable – RCA (Root Cause Analysis & Notifications)

on:
  workflow_call:
    inputs:
      environment:
        description: "Environment where the pipeline ran"
        required: true
        type: string
      build_result:
        description: "Result of the build-test job (success|failure|cancelled|skipped)"
        required: true
        type: string
      deploy_result:
        description: "Result of the deploy job (success|failure|cancelled|skipped)"
        required: true
        type: string
      sit_result:
        description: "Result of the SIT job (success|failure|cancelled|skipped)"
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: rca-${{ github.ref }}
  cancel-in-progress: false

jobs:
  rca:
    name: RCA – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      # ── Step 1: Determine overall pipeline status ──────────────
      - name: Determine pipeline status
        id: status
        run: |
          BUILD="${{ inputs.build_result }}"
          DEPLOY="${{ inputs.deploy_result }}"
          SIT="${{ inputs.sit_result }}"

          echo "Build & Test : $BUILD"
          echo "Deploy       : $DEPLOY"
          echo "SIT          : $SIT"

          if [[ "$BUILD" == "success" && "$DEPLOY" == "success" && "$SIT" == "success" ]]; then
            echo "overall=success" >> "$GITHUB_OUTPUT"
            echo "emoji=✅" >> "$GITHUB_OUTPUT"
            echo "color=good" >> "$GITHUB_OUTPUT"
          elif [[ "$BUILD" == "failure" || "$DEPLOY" == "failure" || "$SIT" == "failure" ]]; then
            echo "overall=failure" >> "$GITHUB_OUTPUT"
            echo "emoji=❌" >> "$GITHUB_OUTPUT"
            echo "color=danger" >> "$GITHUB_OUTPUT"
          else
            echo "overall=partial" >> "$GITHUB_OUTPUT"
            echo "emoji=⚠️" >> "$GITHUB_OUTPUT"
            echo "color=warning" >> "$GITHUB_OUTPUT"
          fi

      # ── Step 2: Download available evidence artifacts ──────────
      - name: Download evidence artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          path: evidence/
          pattern: "*-evidence"
          merge-multiple: true
        continue-on-error: true

      - name: Download test reports
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        with:
          path: reports/
          pattern: "test-report-*"
          merge-multiple: true
        continue-on-error: true

      # ── Step 3: Analyse failures ───────────────────────────────
      - name: Analyse root cause
        if: steps.status.outputs.overall != 'success'
        run: |
          echo "============================================"
          echo "  ROOT CAUSE ANALYSIS"
          echo "============================================"

          if [[ "${{ inputs.build_result }}" == "failure" ]]; then
            echo ""
            echo "FAILED STAGE: Build & Test"
            echo "PROBABLE CAUSE: Compilation error or failing unit tests."
            echo "ACTION ITEMS:"
            echo "  1. Check Maven build output for compilation errors (backend)"
            echo "  2. Check npm build / Vitest output for frontend failures"
            echo "  3. Review test-report-backend and test-report-frontend artifacts"
            echo ""
            if [[ -d reports/ ]]; then
              echo "Available test reports:"
              ls -la reports/ 2>/dev/null || echo "  (none)"
            fi
          elif [[ "${{ inputs.deploy_result }}" == "failure" ]]; then
            echo ""
            echo "FAILED STAGE: Deploy"
            echo "PROBABLE CAUSE: Infrastructure or deployment error."
            echo "ACTION ITEMS:"
            echo "  1. Check Terraform plan/apply output for resource conflicts"
            echo "  2. Verify AWS credentials have sufficient permissions"
            echo "  3. Check Docker build and ECR push logs"
            echo "  4. Review ECS service events for task startup failures"
            echo ""
            if [[ -f evidence/deploy-evidence.json ]]; then
              echo "Deploy evidence:"
              cat evidence/deploy-evidence.json
            fi
          elif [[ "${{ inputs.sit_result }}" == "failure" ]]; then
            echo ""
            echo "FAILED STAGE: SIT (System Integration Tests)"
            echo "PROBABLE CAUSE: Application runtime error or data seeding issue."
            echo "ACTION ITEMS:"
            echo "  1. Check sit-results.json for the specific failing assertion"
            echo "  2. Verify backend is reachable via ALB URL"
            echo "  3. Verify database seeding completed (supply-points > 0)"
            echo "  4. Check ECS task logs in CloudWatch"
            echo ""
            if [[ -f evidence/sit-results.json ]]; then
              echo "SIT results:"
              cat evidence/sit-results.json
            fi
          else
            echo ""
            echo "Pipeline finished with status: ${{ steps.status.outputs.overall }}"
            echo "One or more stages were cancelled or skipped."
          fi

      # ── Step 4: Build RCA report JSON ──────────────────────────
      - name: Build RCA report
        if: always()
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          cat > rca-report.json <<RCAEOF
          {
            "pipeline_run": "${{ github.run_id }}",
            "sha": "${{ github.sha }}",
            "ref": "${{ github.ref }}",
            "actor": "${{ github.actor }}",
            "environment": "${{ inputs.environment }}",
            "timestamp": "$TIMESTAMP",
            "results": {
              "build_test": "${{ inputs.build_result }}",
              "deploy": "${{ inputs.deploy_result }}",
              "sit": "${{ inputs.sit_result }}",
              "overall": "${{ steps.status.outputs.overall }}"
            },
            "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          }
          RCAEOF

          echo "=== RCA Report ==="
          cat rca-report.json

      # ── Step 5: Upload RCA artifacts ───────────────────────────
      - name: Upload RCA report
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: rca-report
          path: |
            rca-report.json
            evidence/
            reports/
          retention-days: 30
          if-no-files-found: warn

      # ── Step 6: Slack notification (optional) ──────────────────
      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [[ -z "$SLACK_WEBHOOK_URL" ]]; then
            echo "Slack webhook not configured — skipping notification."
            exit 0
          fi

          echo "::add-mask::$SLACK_WEBHOOK_URL"

          OVERALL="${{ steps.status.outputs.overall }}"
          EMOJI="${{ steps.status.outputs.emoji }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          curl --silent --fail --max-time 10 \
            -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"text\": \"${EMOJI} Pipeline ${OVERALL} — ${{ inputs.environment }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"${EMOJI} *Pipeline ${OVERALL}* — \`${{ inputs.environment }}\`\n• Build: ${{ inputs.build_result }}\n• Deploy: ${{ inputs.deploy_result }}\n• SIT: ${{ inputs.sit_result }}\n• <${RUN_URL}|View run>\"
                  }
                }
              ]
            }" \
            "$SLACK_WEBHOOK_URL" || echo "Slack notification failed (non-fatal)."

      # ── Step 7: Pipeline summary ───────────────────────────────
      - name: Write pipeline summary
        if: always()
        run: |
          EMOJI="${{ steps.status.outputs.emoji }}"
          {
            echo "## ${EMOJI} Pipeline Summary — ${{ inputs.environment }}"
            echo ""
            echo "| Stage | Result |"
            echo "|-------|--------|"
            echo "| Build & Test | ${{ inputs.build_result }} |"
            echo "| Deploy | ${{ inputs.deploy_result }} |"
            echo "| SIT | ${{ inputs.sit_result }} |"
            echo "| **Overall** | **${{ steps.status.outputs.overall }}** |"
            echo ""
            echo "[View full run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } >> "$GITHUB_STEP_SUMMARY"
