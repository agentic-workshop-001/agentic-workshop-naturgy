name: Reusable – SIT (System Integration Tests)

on:
  workflow_call:
    inputs:
      environment:
        description: "Logical environment name used in job labels (e.g. staging, production)"
        required: false
        type: string
        default: "staging"
    secrets:
      backend_url:
        description: "Base URL of the deployed backend (ALB) — e.g. http://my-alb.region.elb.amazonaws.com"
        required: true
      frontend_url:
        description: "URL of the deployed frontend (S3 static site)"
        required: true

# Minimal permissions — this workflow only reads source code and uploads evidence.
permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  sit-tests:
    name: SIT Tests – ${{ inputs.environment }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Make SIT test script executable
        run: chmod +x scripts/sit-tests.sh

      - name: Run SIT tests
        env:
          BACKEND_URL: ${{ secrets.backend_url }}
          FRONTEND_URL: ${{ secrets.frontend_url }}
        run: ./scripts/sit-tests.sh

      # Upload evidence even when the SIT step fails so engineers can diagnose failures.
      - name: Upload SIT evidence artifacts
        if: always()
        uses: ./.github/actions/upload-evidence
        with:
          name: sit-evidence
          path: |
            sit-results.json
            invoice.pdf
